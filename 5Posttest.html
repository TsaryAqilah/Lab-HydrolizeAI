<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Posttest | Hidrolisis Garam</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg-primary:#f0f9ff;
  --bg-secondary:#ffffff;
  --text-primary:#1e293b;
  --text-secondary:#475569;
  --accent:#8b5cf6;
  --accent-hover:#7c3aed;
  --shadow:rgba(139,92,246,0.15);
}

body{
  font-family:'Poppins',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  min-height:100vh;
}

/* ===== HEADER ===== */
.header{
  background:var(--bg-secondary);
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  box-shadow:0 2px 8px var(--shadow);
  z-index:1000;
}
.logo-section{display:flex;align-items:center;gap:1rem}
.nav-menu{display:flex;gap:1rem}
.nav-btn{
  background:transparent;
  border:2px solid var(--accent);
  padding:0.5rem 1.5rem;
  border-radius:25px;
  cursor:pointer;
  font-weight:500;
  transition:0.3s;
  color:var(--text-primary);
}
.nav-btn:hover{
  background:var(--accent);
  color:white;
  transform:translateY(-2px);
}

/* ===== MAIN ===== */
main{
  max-width:900px;
  margin:2.5rem auto 4rem;
  background:var(--bg-secondary);
  padding:2rem;
  border-radius:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.1);
}

.hidden{display:none!important}

h2{color:var(--accent);margin-bottom:1rem}

/* ===== SETUP BANNER ===== */
.setup-banner{
  background:linear-gradient(135deg,#f3e8ff,#e9d5ff);
  border:2px solid #a855f7;
  border-radius:15px;
  padding:1.2rem 1.5rem;
  margin-bottom:1.5rem;
}
.setup-banner summary{
  cursor:pointer;
  font-weight:600;
  color:#6b21a8;
  font-size:0.95rem;
}
.setup-banner ol{
  margin-top:0.8rem;
  padding-left:1.2rem;
  color:#581c87;
  font-size:0.88rem;
  line-height:2;
}
.setup-banner code{
  background:#fff;
  border:1px solid #a855f7;
  border-radius:6px;
  padding:2px 6px;
  font-size:0.85rem;
  font-family:monospace;
}
.setup-input{
  display:flex;
  gap:0.5rem;
  margin-top:0.8rem;
  flex-wrap:wrap;
}
.setup-input input{
  flex:1;
  min-width:200px;
  padding:0.5rem 0.8rem;
  border-radius:10px;
  border:2px solid #a855f7;
  font-size:0.9rem;
  margin-bottom:0;
}
.setup-input button{
  background:#a855f7;
  color:white;
  border:none;
  padding:0.5rem 1.2rem;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
.setup-input button:hover{background:#9333ea}
.connected-badge{
  display:inline-block;
  background:#dcfce7;
  color:#166534;
  border:2px solid #22c55e;
  border-radius:20px;
  padding:0.3rem 1rem;
  font-size:0.85rem;
  font-weight:600;
  margin-top:0.5rem;
}
.offline-badge{
  display:inline-block;
  background:#f3e8ff;
  color:#6b21a8;
  border:2px solid #a855f7;
  border-radius:20px;
  padding:0.3rem 1rem;
  font-size:0.85rem;
  font-weight:600;
  margin-top:0.5rem;
}

/* ===== LOGIN FORM ===== */
input{
  width:100%;
  padding:0.8rem;
  margin-bottom:1rem;
  border-radius:12px;
  border:2px solid #e2e8f0;
  font-size:1rem;
  transition:0.3s;
}
input:focus{
  outline:none;
  border-color:var(--accent);
}

.primary{
  background:var(--accent);
  color:white;
  border:none;
  padding:0.8rem 2rem;
  border-radius:25px;
  cursor:pointer;
  font-weight:600;
  font-size:1rem;
  transition:0.3s;
}
.primary:hover{
  background:var(--accent-hover);
  transform:translateY(-2px);
}

/* ===== PROGRESS ===== */
.progress-text{
  display:flex;
  justify-content:space-between;
  font-weight:500;
  margin-bottom:0.5rem;
  color:var(--text-secondary);
}
.progress-bar{
  width:100%;
  height:10px;
  background:#e2e8f0;
  border-radius:20px;
  overflow:hidden;
  margin-bottom:1.5rem;
}
.progress-fill{
  height:100%;
  background:linear-gradient(135deg,#8b5cf6,#ec4899);
  transition:width 0.3s;
}

/* ===== QUESTION ===== */
.question{
  font-size:1.1rem;
  margin-bottom:1.5rem;
  line-height:1.6;
}

/* ===== OPTIONS ===== */
.option-btn{
  width:100%;
  text-align:left;
  padding:1rem 1.2rem;
  margin-bottom:0.75rem;
  border:2px solid #e2e8f0;
  border-radius:15px;
  background:white;
  cursor:pointer;
  transition:0.25s;
  font-size:1rem;
}
.option-btn:hover:not(:disabled){
  border-color:var(--accent);
  background:#f5f3ff;
  transform:translateX(5px);
}
.option-btn.correct{
  border-color:#22c55e;
  background:#dcfce7;
}
.option-btn.wrong{
  border-color:#ef4444;
  background:#fee2e2;
}
.option-btn:disabled{
  cursor:not-allowed;
}

/* ===== EXPLANATION ===== */
.explanation{
  margin-top:1.5rem;
  padding:1.2rem;
  background:#f3e8ff;
  border-left:5px solid var(--accent);
  border-radius:10px;
  display:none;
  line-height:1.6;
}

/* ===== NAVIGATION ===== */
.nav-quiz{
  display:flex;
  justify-content:space-between;
  margin-top:2rem;
  gap:1rem;
}
.nav-quiz button{
  padding:0.8rem 1.8rem;
  border:none;
  border-radius:25px;
  font-weight:600;
  cursor:pointer;
  font-size:1rem;
  transition:0.3s;
}
.prev{
  background:#e2e8f0;
  color:var(--text-primary);
}
.prev:hover:not(:disabled){
  background:#cbd5e1;
}
.next{
  background:var(--accent);
  color:white;
}
.next:hover:not(:disabled){
  background:var(--accent-hover);
  transform:translateY(-2px);
}
.nav-quiz button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

/* ===== RESULT ===== */
.result{
  text-align:center;
}
.result h2{
  margin-bottom:0.5rem;
  font-size:2rem;
}
.score-display{
  font-size:1.3rem;
  margin:1rem 0;
  color:var(--text-secondary);
}
.review{
  margin-top:2rem;
  text-align:left;
}
.review-item{
  padding:1.2rem;
  border-radius:12px;
  margin-bottom:1rem;
  line-height:1.6;
}
.review-item.correct{
  background:#dcfce7;
  border-left:5px solid #22c55e;
}
.review-item.wrong{
  background:#fee2e2;
  border-left:5px solid #ef4444;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:1.5rem;
}
th,td{
  border:1px solid #cbd5e1;
  padding:0.8rem;
  text-align:center;
}
th{
  background:#f3e8ff;
  color:var(--accent);
  font-weight:600;
}
tr:hover{
  background:#faf5ff;
}

/* ===== LOADING ===== */
.loading-row td{
  color:var(--text-secondary);
  font-style:italic;
  animation:pulse 1.5s infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* ===== FOOTER ===== */
footer{
  background:white;
  text-align:center;
  padding:1.5rem;
  box-shadow:0 -2px 8px var(--shadow);
  margin-top:2rem;
}

/* ===== RESPONSIVE ===== */
@media (max-width:768px) {
  .header{
    flex-direction:column;
    gap:1rem;
    padding:1rem;
  }
  .logo-section,.nav-menu{
    width:100%;
    justify-content:center;
  }
  .nav-menu{
    flex-wrap:wrap;
  }
  main{
    margin:1rem;
    padding:1.5rem;
  }
  .nav-quiz{
    flex-direction:column;
  }
  table{
    font-size:0.85rem;
  }
  th,td{
    padding:0.5rem;
  }
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="logo-section">
    <img src="logo um rev.png" alt="Logo UM" width="50">
  </div>
  <div class="nav-menu">
    <button class="nav-btn" onclick="history.back()">‚Üê Kembali</button>
    <button class="nav-btn" onclick="location.href='2Beranda.html'">üè† Beranda</button>
    <button class="nav-btn" onclick="location.href='2Profil.html'">üë§ Profil</button>
  </div>
</div>

<main>

<!-- SETUP BANNER -->
<details class="setup-banner" id="setupBanner">
  <summary>‚öôÔ∏è Pengaturan Cloud Sync (Klik untuk melihat) ‚Äî Skor tersinkron antar perangkat</summary>
  <ol>
    <li>Buka <a href="https://firebase.google.com" target="_blank"><strong>firebase.google.com</strong></a> ‚Üí Masuk dengan akun Google</li>
    <li>Klik <strong>Get started</strong> ‚Üí <strong>Create a project</strong> ‚Üí beri nama bebas (misal: <code>hidrolisis-garam</code>)</li>
    <li>Di dashboard, klik <strong>Realtime Database</strong> ‚Üí <strong>Create Database</strong> ‚Üí pilih lokasi ‚Üí pilih <strong>Start in test mode</strong></li>
    <li>Copy URL database Anda (format: <code>https://nama-project-default-rtdb.firebaseio.com</code>)</li>
    <li>Tempel URL di bawah lalu klik Simpan: <em>(URL yang sama dengan pretest boleh digunakan)</em></li>
  </ol>
  <div class="setup-input">
    <input type="text" id="firebaseUrlInput" placeholder="https://nama-project-default-rtdb.firebaseio.com">
    <button onclick="saveFirebaseUrl()">üíæ Simpan</button>
  </div>
  <div id="connectionStatus"></div>
  <p style="margin-top:0.8rem;font-size:0.8rem;color:#6b21a8">‚ö†Ô∏è Jika belum diatur, skor hanya tersimpan di perangkat ini (offline mode).</p>
</details>

<!-- LOGIN BOX -->
<div id="loginBox">
  <h2>üîê Identitas Peserta</h2>
  <p style="margin-bottom:1.5rem;color:var(--text-secondary)">Silakan isi identitas Anda sebelum memulai posttest</p>
  <input id="nama" placeholder="Nama Lengkap" type="text">
  <input id="kelas" placeholder="Kelas" type="text">
  <input id="absen" placeholder="Nomor Absen" type="number">
  <button class="primary" onclick="startQuiz()">Mulai Posttest</button>
</div>

<!-- QUIZ BOX -->
<div id="quizBox" class="hidden">
  <div class="progress-text">
    <span>Progress</span>
    <span id="progressText">1 / 20</span>
  </div>
  <div class="progress-bar">
    <div id="progressFill" class="progress-fill" style="width:5%"></div>
  </div>

  <h2 id="questionNumber">Pertanyaan 1</h2>
  <p id="questionText" class="question"></p>

  <div id="options"></div>

  <div id="explanation" class="explanation"></div>

  <div class="nav-quiz">
    <button id="prevBtn" class="prev" disabled>‚Üê Sebelumnya</button>
    <button id="nextBtn" class="next" disabled>Selanjutnya ‚Üí</button>
  </div>
</div>

<!-- RESULT BOX -->
<div id="resultBox" class="result hidden">
  <h2>üéâ Posttest Selesai!</h2>
  <p class="score-display">Skor Anda: <strong id="scoreText"></strong></p>

  <div class="review" id="reviewBox"></div>

  <button class="primary" style="margin-top:1.5rem" onclick="restartQuiz()">üîÑ Mulai Ulang</button>
</div>

<!-- SCOREBOARD -->
<hr style="margin:3rem 0 2rem;border:none;border-top:2px solid #e2e8f0">

<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:0.5rem">
  <div>
    <h2 style="margin-bottom:0.2rem">üìä Papan Skor ‚Äî Posttest</h2>
    <p style="color:var(--text-secondary);font-size:0.9rem">Daftar peserta yang telah mengerjakan posttest</p>
  </div>
  <span id="syncIndicator" class="offline-badge">üíæ Mode Offline</span>
</div>

<table>
<thead>
<tr>
  <th>No</th>
  <th>Nama</th>
  <th>Kelas</th>
  <th>Absen</th>
  <th>Skor</th>
  <th>Waktu</th>
</tr>
</thead>
<tbody id="scoreTable"><tr class="loading-row"><td colspan="6">Memuat data...</td></tr></tbody>
</table>

<div style="display:flex;gap:1rem;margin-top:1.5rem;flex-wrap:wrap">
  <button class="primary" onclick="loadScoreboard()">üîÑ Refresh Skor</button>
  <button class="primary" style="background:#ef4444" onclick="resetScore()">üîë Reset Papan Skor (Guru)</button>
</div>

</main>

<footer>&copy; 2026 Tsary ‚ñè Sumari ‚ñè Departemen Kimia ‚ñè Universitas Negeri Malang</footer>

<script>
// =============================================
// KONFIGURASI FIREBASE
// =============================================
const STORAGE_KEY_URL = 'firebaseUrl_hidrolisis'; // sama dengan pretest ‚Äî berbagi 1 project Firebase
const LOCAL_KEY = 'posttestScores_local';
const FIREBASE_PATH = 'posttest'; // BERBEDA dari pretest agar skor tidak tercampur

let firebaseUrl = localStorage.getItem(STORAGE_KEY_URL) || '';

function getApiUrl(){
  if(!firebaseUrl) return null;
  const base = firebaseUrl.replace(/\/+$/, '');
  return `${base}/${FIREBASE_PATH}.json`;
}

function saveFirebaseUrl(){
  const val = document.getElementById('firebaseUrlInput').value.trim();
  if(!val){
    alert('‚ö†Ô∏è URL tidak boleh kosong!');
    return;
  }
  firebaseUrl = val.replace(/\/+$/, '');
  localStorage.setItem(STORAGE_KEY_URL, firebaseUrl);
  updateConnectionStatus(true);
  loadScoreboard();
}

function updateConnectionStatus(saved){
  const el = document.getElementById('connectionStatus');
  const indicator = document.getElementById('syncIndicator');
  if(firebaseUrl){
    el.innerHTML = '<span class="connected-badge">‚úÖ Cloud terhubung ‚Äî skor tersinkron antar perangkat</span>';
    if(indicator) indicator.className = 'connected-badge';
    if(indicator) indicator.textContent = '‚òÅÔ∏è Cloud Sync Aktif';
    document.getElementById('firebaseUrlInput').value = firebaseUrl;
  } else {
    el.innerHTML = '';
    if(indicator) indicator.className = 'offline-badge';
    if(indicator) indicator.textContent = 'üíæ Mode Offline';
  }
}

// =============================================
// QUIZ DATA
// =============================================
const quizData=[
  {
    question:"Garam yang menghasilkan larutan basa saat dilarutkan dalam air adalah ...",
    options:["NaCl","HCl","NH‚ÇÑCl","CH‚ÇÉCOONa","CH‚ÇÉCOOH"],
    correct:3,
    explanation:"CH‚ÇÉCOONa berasal dari asam lemah (CH‚ÇÉCOOH) dan basa kuat (NaOH) sehingga larutannya bersifat basa."
  },
  {
    question:"Larutan NH‚ÇÑCl bersifat asam karena ...",
    options:["NH‚ÇÑ‚Å∫ menghasilkan H‚Å∫","Cl‚Åª menghasilkan OH‚Åª","Tidak terhidrolisis","pH = 7","Larut sempurna"],
    correct:0,
    explanation:"Ion NH‚ÇÑ‚Å∫ terhidrolisis dalam air menghasilkan ion H‚Å∫, sehingga larutan bersifat asam."
  },
  {
    question:"NaCl bersifat netral karena ...",
    options:["Tidak larut dalam air","Berasal dari asam kuat & basa kuat","Terhidrolisis total","pH > 7","Menghasilkan OH‚Åª"],
    correct:1,
    explanation:"NaCl berasal dari asam kuat (HCl) dan basa kuat (NaOH) sehingga tidak terhidrolisis dan bersifat netral."
  },
  {
    question:"Ion yang terhidrolisis pada CH‚ÇÉCOONa adalah ...",
    options:["Na‚Å∫","H‚ÇÇO","CH‚ÇÉCOO‚Åª","H‚Å∫","OH‚Åª"],
    correct:2,
    explanation:"Ion asetat (CH‚ÇÉCOO‚Åª) bereaksi dengan air menghasilkan OH‚Åª, menyebabkan larutan bersifat basa."
  },
  {
    question:"Reaksi antara ion garam dengan air disebut ...",
    options:["Ionisasi","Netralisasi","Hidrolisis","Oksidasi","Reduksi"],
    correct:2,
    explanation:"Hidrolisis adalah reaksi antara ion-ion garam dengan molekul air yang menghasilkan ion H‚Å∫ atau OH‚Åª."
  },
  {
    question:"Garam dari asam lemah dan basa kuat akan menghasilkan larutan bersifat ...",
    options:["Asam","Netral","Basa","Amfoter","Tidak tentu"],
    correct:2,
    explanation:"Anion dari asam lemah akan terhidrolisis menghasilkan OH‚Åª, sehingga larutan bersifat basa."
  },
  {
    question:"NH‚ÇÑ‚Å∫ berasal dari basa ...",
    options:["Kuat","Lemah","Amfoter","Netral","Tidak bereaksi"],
    correct:1,
    explanation:"NH‚ÇÑ‚Å∫ berasal dari basa lemah NH‚ÇÉ (amonia)."
  },
  {
    question:"Ion Cl‚Åª tidak terhidrolisis karena berasal dari ...",
    options:["Asam lemah","Asam kuat","Basa lemah","Basa netral","Garam"],
    correct:1,
    explanation:"Ion Cl‚Åª berasal dari asam kuat HCl, sehingga tidak bereaksi dengan air (tidak terhidrolisis)."
  },
  {
    question:"pH larutan CH‚ÇÉCOONa adalah ...",
    options:["< 7","= 7","> 7","0","14"],
    correct:2,
    explanation:"CH‚ÇÉCOONa bersifat basa sehingga pH-nya lebih besar dari 7."
  },
  {
    question:"Hidrolisis total terjadi pada garam dari ...",
    options:["Asam kuat - basa kuat","Asam lemah - basa kuat","Asam kuat - basa lemah","Asam lemah - basa lemah","Tidak ada"],
    correct:3,
    explanation:"Hidrolisis total terjadi ketika kation dan anion sama-sama terhidrolisis, yaitu pada garam dari asam lemah dan basa lemah."
  },
  {
    question:"Contoh garam yang bersifat asam adalah ...",
    options:["NaCl","NH‚ÇÑCl","K‚ÇÇSO‚ÇÑ","CH‚ÇÉCOONa","Na‚ÇÇCO‚ÇÉ"],
    correct:1,
    explanation:"NH‚ÇÑCl berasal dari asam kuat (HCl) dan basa lemah (NH‚ÇÉ), sehingga bersifat asam."
  },
  {
    question:"Larutan basa terasa licin karena ...",
    options:["Mengandung H‚Å∫","Mengandung OH‚Åª","pH rendah","Asam kuat","Netral"],
    correct:1,
    explanation:"Larutan basa mengandung ion OH‚Åª yang membuat larutan terasa licin."
  },
  {
    question:"Ion CO‚ÇÉ¬≤‚Åª dalam air akan menghasilkan ...",
    options:["H‚Å∫","OH‚Åª","H‚ÇÇ","O‚ÇÇ","CO‚ÇÇ"],
    correct:1,
    explanation:"Ion CO‚ÇÉ¬≤‚Åª bereaksi dengan air menghasilkan HCO‚ÇÉ‚Åª dan OH‚Åª."
  },
  {
    question:"Jika Ka > Kb maka larutan garam bersifat ...",
    options:["Asam","Netral","Basa","Tidak tentu","Amfoter"],
    correct:0,
    explanation:"Jika Ka (tetapan ionisasi asam) lebih besar dari Kb (tetapan ionisasi basa), maka larutan bersifat asam."
  },
  {
    question:"Jika Kb > Ka maka larutan garam bersifat ...",
    options:["Asam","Netral","Basa","Amfoter","Tidak tentu"],
    correct:2,
    explanation:"Jika Kb lebih besar dari Ka, maka sifat basa lebih dominan sehingga larutan bersifat basa."
  },
  {
    question:"Contoh garam netral adalah ...",
    options:["NH‚ÇÑCl","NaCl","KCN","CH‚ÇÉCOONa","(NH‚ÇÑ)‚ÇÇCO‚ÇÉ"],
    correct:1,
    explanation:"NaCl berasal dari asam kuat (HCl) dan basa kuat (NaOH) sehingga bersifat netral."
  },
  {
    question:"Hidrolisis parsial terjadi pada ...",
    options:["Asam kuat - basa kuat","Asam lemah - basa kuat","Asam lemah - basa lemah","Semua garam","Tidak ada"],
    correct:1,
    explanation:"Hidrolisis parsial terjadi ketika hanya satu ion yang terhidrolisis, misalnya pada garam dari asam lemah dan basa kuat."
  },
  {
    question:"Ion yang TIDAK bereaksi dengan air adalah ...",
    options:["NH‚ÇÑ‚Å∫","CN‚Åª","Cl‚Åª","CH‚ÇÉCOO‚Åª","CO‚ÇÉ¬≤‚Åª"],
    correct:2,
    explanation:"Ion Cl‚Åª berasal dari asam kuat sehingga tidak bereaksi dengan air."
  },
  {
    question:"CH‚ÇÉCOOH adalah asam ...",
    options:["Kuat","Lemah","Netral","Amfoter","Basa"],
    correct:1,
    explanation:"CH‚ÇÉCOOH (asam asetat) adalah asam lemah yang tidak terionisasi sempurna dalam air."
  },
  {
    question:"Tujuan utama mempelajari hidrolisis garam adalah untuk menentukan ...",
    options:["Massa garam","Volume larutan","pH larutan","Suhu larutan","Warna larutan"],
    correct:2,
    explanation:"Dengan memahami hidrolisis garam, kita dapat menentukan pH larutan garam tersebut."
  }
];

let index=0, score=0, answers=[], userData={};

const qText=document.getElementById("questionText");
const qNum=document.getElementById("questionNumber");
const optBox=document.getElementById("options");
const expl=document.getElementById("explanation");
const progressFill=document.getElementById("progressFill");
const progressText=document.getElementById("progressText");
const prevBtn=document.getElementById("prevBtn");
const nextBtn=document.getElementById("nextBtn");

function startQuiz(){
  const nama = document.getElementById("nama").value.trim();
  const kelas = document.getElementById("kelas").value.trim();
  const absen = document.getElementById("absen").value.trim();
  if(!nama || !kelas || !absen){
    alert("‚ö†Ô∏è Mohon lengkapi semua identitas!");
    return;
  }
  userData = {nama, kelas, absen};
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("quizBox").classList.remove("hidden");
  loadQuestion();
}

function loadQuestion(){
  const q=quizData[index];
  qNum.textContent=`Pertanyaan ${index+1}`;
  qText.textContent=q.question;
  optBox.innerHTML="";
  expl.style.display="none";
  progressFill.style.width=`${((index+1)/quizData.length)*100}%`;
  progressText.textContent=`${index+1} / ${quizData.length}`;
  prevBtn.disabled=index===0;
  nextBtn.disabled=true;

  q.options.forEach((opt,i)=>{
    const btn=document.createElement("button");
    btn.className="option-btn";
    btn.textContent=String.fromCharCode(65+i)+". "+opt;
    btn.onclick=()=>selectOption(btn,i);
    optBox.appendChild(btn);
  });
}

function selectOption(btn,i){
  const q=quizData[index];
  const buttons=document.querySelectorAll(".option-btn");
  buttons.forEach(b=>b.disabled=true);
  if(i===q.correct){
    btn.classList.add("correct");
    score++;
  }else{
    btn.classList.add("wrong");
    buttons[q.correct].classList.add("correct");
  }
  expl.textContent="üí° "+q.explanation;
  expl.style.display="block";
  answers[index]=i;
  nextBtn.disabled=false;
}

nextBtn.onclick=()=>{
  if(index<quizData.length-1){index++;loadQuestion();}
  else showResult();
};

prevBtn.onclick=()=>{index--;loadQuestion();};

function showResult(){
  document.getElementById("quizBox").classList.add("hidden");
  document.getElementById("resultBox").classList.remove("hidden");
  document.getElementById("scoreText").textContent=`${score} / ${quizData.length}`;

  const review=document.getElementById("reviewBox");
  review.innerHTML="";
  quizData.forEach((q,i)=>{
    const div=document.createElement("div");
    const correct=answers[i]===q.correct;
    div.className=`review-item ${correct?'correct':'wrong'}`;
    div.innerHTML=`
      <strong>Pertanyaan ${i+1}:</strong> ${q.question}<br>
      <strong>Jawaban Anda:</strong> ${q.options[answers[i]] || '-'}<br>
      <strong>Jawaban Benar:</strong> ${q.options[q.correct]}<br>
      <em>${q.explanation}</em>
    `;
    review.appendChild(div);
  });
  saveScore();
}

function restartQuiz(){
  index=0;score=0;answers=[];
  document.getElementById("resultBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
  document.getElementById("nama").value="";
  document.getElementById("kelas").value="";
  document.getElementById("absen").value="";
}

// =============================================
// CLOUD STORAGE (Firebase) + LOCAL FALLBACK
// =============================================

async function saveScore(){
  const entry = {
    ...userData,
    score:`${score}/${quizData.length}`,
    scoreNum: score,
    total: quizData.length,
    time: new Date().toLocaleString('id-ID'),
    ts: Date.now()
  };

  const local = JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]');
  local.push(entry);
  localStorage.setItem(LOCAL_KEY, JSON.stringify(local));

  if(firebaseUrl){
    try{
      const url = getApiUrl();
      const res = await fetch(url);
      const existing = await res.json() || [];
      const arr = Array.isArray(existing) ? existing : Object.values(existing);
      arr.push(entry);
      await fetch(url, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(arr)
      });
      console.log('‚úÖ Skor posttest tersimpan ke cloud');
    }catch(e){
      console.warn('‚ö†Ô∏è Gagal simpan ke cloud', e);
    }
  }

  loadScoreboard();
}

async function loadScoreboard(){
  const scoreTable = document.getElementById("scoreTable");
  scoreTable.innerHTML = '<tr class="loading-row"><td colspan="6">Memuat data...</td></tr>';

  let data = [];

  if(firebaseUrl){
    try{
      const url = getApiUrl();
      const res = await fetch(url);
      const raw = await res.json();
      if(raw){
        data = Array.isArray(raw) ? raw : Object.values(raw);
      }
    }catch(e){
      console.warn('‚ö†Ô∏è Gagal mengambil data cloud, tampilkan lokal');
      data = JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]');
    }
  } else {
    data = JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]');
  }

  data.sort((a,b)=>(b.ts||0)-(a.ts||0));
  renderScoreboard(data);
}

function renderScoreboard(data){
  const scoreTable = document.getElementById("scoreTable");
  scoreTable.innerHTML = '';

  if(!data || data.length === 0){
    scoreTable.innerHTML = '<tr><td colspan="6" style="color:var(--text-secondary)">Belum ada data</td></tr>';
    return;
  }

  data.forEach((d,i)=>{
    scoreTable.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${d.nama || '-'}</td>
      <td>${d.kelas || '-'}</td>
      <td>${d.absen || '-'}</td>
      <td><strong>${d.score}</strong></td>
      <td>${d.time || '-'}</td>
    </tr>`;
  });
}

async function resetScore(){
  const pass = prompt("üîë Masukkan password guru:");
  if(pass === "kimtaerae"){
    localStorage.removeItem(LOCAL_KEY);
    if(firebaseUrl){
      try{
        await fetch(getApiUrl(), {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:'[]'
        });
      }catch(e){console.warn('Gagal reset cloud')}
    }
    renderScoreboard([]);
    alert("‚úÖ Papan skor posttest berhasil direset!");
  } else if(pass !== null){
    alert("‚ùå Password salah!");
  }
}

// =============================================
// INIT
// =============================================
updateConnectionStatus(false);
loadScoreboard();
</script>

</body>
</html>
